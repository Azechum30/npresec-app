generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String       @id @default(cuid())
  email                    String       @unique
  username                 String       @unique
  roleId                   String?
  name                     String?
  linkedInUrl              String?
  xUrl                     String?
  facebookUrl              String?
  instagramUrl             String?
  bio                      String?
  subscribeToOurNewsLetter Boolean?     @default(false)
  socials                  Json?
  timezone                 String?      @default("Africa/Accra")
  dateFormat               String?      @default("DD/MM/YYYY")
  itemsPerPage             Int?         @default(10)
  emailNotifications       Json?
  notificationFrequency    String?      @default("realtime")
  theme                    String?      @default("system")
  compactMode              Boolean      @default(false)
  showTips                 Boolean      @default(false)
  image                    String?
  emailVerified            Boolean?     @default(false)
  sessions                 Session[]
  student                  Student?
  staff                    Staff?
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @default(now()) @updatedAt
  role                     Role?        @relation(fields: [roleId], references: [id])
  permissions              Permission[] @relation("UserPermissions")
  accounts                 Account[]

  @@index([roleId, email, username])
  @@map("users")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  token     String   @unique
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  code        String    @unique
  description String?
  headId      String?   @unique
  createdAt   DateTime  @default(now())
  updatedat   DateTime  @updatedAt
  classes     Class[]
  head        Staff?    @relation("Head", fields: [headId], references: [id], onDelete: SetNull)
  students    Student[]
  staff       Staff[]   @relation("DepartmentStaff")
  courses     Course[]  @relation("CourseDepartments")

  @@index([name, code])
  @@map("departments")
}

model Staff {
  id                     String        @id @default(cuid())
  employeeId             String        @unique
  userId                 String?       @unique
  departmentId           String?
  firstName              String
  lastName               String
  middleName             String?
  birthDate              DateTime
  dateOfFirstAppointment DateTime?
  gender                 String
  maritalStatus          String
  rgNumber               String?       @unique
  rank                   String?
  academicQual           String?
  ssnitNumber            String?       @unique
  ghcardNumber           String?       @unique
  phone                  String
  licencedNumber         String?       @unique
  staffType              StaffType     @default(Teaching)
  staffCategory          StaffCategory @default(Professional)
  houseMaster            House?        @relation("HouseMaster")
  departmentHead         Department?   @relation("Head")
  department             Department?   @relation("DepartmentStaff", fields: [departmentId], references: [id])
  user                   User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes                Class[]       @relation("ClassStaff")
  courses                Course[]      @relation("CourseStaff")
  grades                 Grade[] // Grades assigned by this staff member

  @@index([employeeId, firstName, lastName, gender])
  @@map("staff")
}

model Course {
  id          String       @id @default(cuid())
  code        String       @unique
  title       String       @unique
  description String?
  credits     Int?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  grades      Grade[]
  classes     Class[]      @relation("ClassCourses")
  departments Department[] @relation("CourseDepartments")
  staff       Staff[]      @relation("CourseStaff")

  @@index([code, title])
  @@map("courses")
}

model Class {
  id                String       @id @default(cuid())
  name              String       @unique
  code              String       @unique
  level             Level        @default(Year_One)
  staffId           String?
  departmentId      String?
  maxCapacity       Int?
  currentEnrollment Int          @default(0)
  attendance        Attendance[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  department        Department?  @relation(fields: [departmentId], references: [id])
  students          Student[]
  courses           Course[]     @relation("ClassCourses")
  staff             Staff[]      @relation("ClassStaff")

  @@index([code, name])
  @@map("classes")
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  users       User[]
  permissions Permission[] @relation("RolePermissions")

  @@index([name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  roles       Role[]   @relation("RolePermissions")
  users       User[]   @relation("UserPermissions")

  @@index([name])
  @@map("permissions")
}

model Student {
  id               String             @id @default(cuid())
  firstName        String
  lastName         String
  middleName       String?
  studentNumber    String             @unique
  birthDate        DateTime
  gender           String
  departmentId     String?
  userId           String?            @unique
  classId          String?
  dateEnrolled     DateTime           @default(now())
  graduationDate   DateTime?
  currentLevel     Level              @default(Year_One)
  status           EnrollmentStatus   @default(Active)
  phone            String?
  address          String?
  nationality      String?
  religion         String?
  guardianName     String
  guardianPhone    String
  guardianEmail    String?
  guardianAddress  String?
  guardianRelation String
  previousSchool   String?
  admissionDate    DateTime           @default(now())
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  attendance       Attendance[]
  documents        Document[]
  grades           Grade[]
  transcripts      Transcript[]
  currentClass     Class?             @relation(fields: [classId], references: [id])
  department       Department?        @relation(fields: [departmentId], references: [id])
  user             User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  houseId          String?            @unique
  roomId           String?            @unique
  room             Room?              @relation(fields: [roomId], references: [id])
  house            House?             @relation(fields: [houseId], references: [id])
  promotions       StudentPromotion[]

  @@index([departmentId, currentLevel])
  @@index([firstName, lastName, studentNumber])
  @@index([currentLevel, status])
  @@map("students")
}

model Attendance {
  id           String           @id @default(cuid())
  date         DateTime         @db.Date
  status       AttendanceStatus
  semester     Semester?
  academicYear String?
  studentId    String
  classId      String
  student      Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class            @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, date, classId])
  @@unique([studentId, date])
  @@map("attendance")
}

model Grade {
  id             String         @id @default(cuid())
  courseId       String
  studentId      String
  staffId        String?
  assessmentType AssessmentType
  score          Float
  maxScore       Float          @default(100) // Maximum possible score
  weight         Float?         @default(1.0) // Weight of this assessment (e.g., 0.3 for 30%)
  semester       Semester
  academicYear   Int // e.g., 2024
  isExempt       Boolean        @default(false) // For exempted assessments
  isRetake       Boolean        @default(false) // For retake exams
  remarks        String? // Staff comments
  gradedAt       DateTime? // When the grade was assigned
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  staff   Staff?  @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@unique([studentId, courseId, assessmentType, semester, academicYear])
  @@index([studentId, academicYear])
  @@index([courseId, academicYear, semester])
  @@index([staffId, academicYear])
  @@map("grades")
}

model Document {
  id         String   @id @default(cuid())
  name       String
  type       String
  url        String
  studentId  String?
  uploadedAt DateTime @default(now())
  student    Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model BoardMember {
  id          String          @id @default(cuid())
  name        String
  role        BoardMemberRole @default(Member)
  affiliation String?
  bio         String?
  picture     String?
  is_active   Boolean         @default(true)

  @@map("board_members")
}

model Transcript {
  id             String    @id @default(cuid())
  studentId      String
  academicYear   Int
  semester       Semester?
  gpa            Float?
  totalCredits   Int?
  generatedAt    DateTime  @default(now())
  pdfUrl         String?
  isOfficial     Boolean   @default(false)
  student        Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  transcriptData Json?

  @@unique([studentId, academicYear, semester])
  @@index([studentId])
  @@index([academicYear])
  @@map("transcripts")
}

model House {
  id            String      @id @default(cuid())
  name          String      @unique
  residencyType HouseType   @default(DAY)
  houseGender   HouseGender @default(BOTH)
  occupancy     Json
  students      Student[]
  rooms         Room[]
  houseMasterId String?     @unique
  houseMaster   Staff?      @relation("HouseMaster", fields: [houseMasterId], references: [id], onDelete: SetNull)

  @@map("houses")
}

model Room {
  id        String      @id @default(cuid())
  code      String      @unique
  rmGender  HouseGender @default(BOTH)
  capacity  Int
  houseId   String
  house     House       @relation(fields: [houseId], references: [id], onDelete: Cascade)
  students  Student[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@map("rooms")
}

model StudentPromotion {
  id            String   @id @default(cuid())
  studentId     String
  fromLevel     Level
  toLevel       Level?
  academicYear  Int
  promotedAt    DateTime @default(now())
  promotedBy    String? // User ID who performed the promotion
  criteria      Json? // Store promotion criteria details
  forcePromoted Boolean  @default(false)
  notes         String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, academicYear])
  @@index([academicYear, fromLevel])
  @@map("student_promotions")
}

enum HouseGender {
  MALE
  FEMALE
  BOTH
}

enum HouseType {
  DAY
  BOARDING
  MIXED
}

enum BoardMemberRole {
  ChairPerson
  ViceChairPerson
  Secretary
  Member
}

enum Semester {
  First
  Second
}

enum AssessmentType {
  Assignment
  Midterm
  Project
  Examination
}

enum AttendanceStatus {
  Present
  Absent
  Late
  Excused
}

enum Level {
  Year_One
  Year_Two
  Year_Three
}

enum EnrollmentStatus {
  Active
  Inactive
  Suspended
  Graduated
  Withdrawn
}

enum StaffType {
  Teaching
  Non_Teaching
}

enum StaffCategory {
  Professional
  Non_Professional
}
